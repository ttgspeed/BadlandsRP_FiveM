local units_two = {
    { name = "1", x = -1493.4108886719, y = -667.97552490234, z = 29.025072097778, h = 141.66059875488 },
    { name = "2", x = -1498.0126953125, y = -664.73162841797, z = 29.025087356567, h = 139.73707580566 },
    { name = "3", x = -1495.3590087891, y = -661.5869140625, z = 29.025087356567, h = 37.434795379639 },
    { name = "4", x = -1490.6943359375, y = -658.30841064453, z = 29.025085449219, h = 31.892972946167 },
    { name = "5", x = -1486.6990966797, y = -655.400390625, z = 29.583061218262, h = 44.836574554443 },
    { name = "6", x = -1482.2397460938, y = -652.07183837891, z = 29.583070755005, h = 37.552642822266 },
    { name = "7", x = -1478.1522216797, y = -649.14929199219, z = 29.583068847656, h = 41.937004089355 },
    { name = "8", x = -1473.638671875, y = -645.89965820313, z = 29.583070755005, h = 33.83963394165 },
    { name = "9", x = -1469.6915283203, y = -643.04486083984, z = 29.58306312561, h = 34.934692382813 },
    { name = "10", x = -1465.1202392578, y = -639.73565673828, z = 29.583057403564, h = 32.041797637939 },
    { name = "11", x = -1461.3092041016, y = -640.90069580078, z = 29.583116531372, h = 311.34841918945 },
    { name = "12", x = -1452.4534912109, y = -653.18786621094, z = 29.583168029785, h = 303.05084228516 },
    { name = "13", x = -1454.4317626953, y = -655.91137695313, z = 29.583066940308, h = 214.37561035156 },
    { name = "14", x = -1458.9293212891, y = -659.1708984375, z = 29.583070755005, h = 214.57518005371 },
    { name = "15", x = -1462.9853515625, y = -662.11376953125, z = 29.58306312561, h = 221.27893066406 },
    { name = "16", x = -1467.5111083984, y = -665.48724365234, z = 29.583076477051, h = 219.95883178711 },
    { name = "17", x = -1471.5029296875, y = -668.43005371094, z = 29.583135604858, h = 217.13919067383 },
    { name = "18", x = -1461.2722167969, y = -640.96722412109, z = 33.381278991699, h = 311.44879150391 },
    { name = "19", x = -1457.9284667969, y = -645.58898925781, z = 33.38126373291, h = 309.779296875 },
    { name = "20", x = -1455.6176757813, y = -648.60144042969, z = 33.38126373291, h = 307.29852294922 },
    { name = "21", x = -1452.4313964844, y = -653.25042724609, z = 33.38126373291, h = 315.30813598633 },
    { name = "22", x = -1454.3692626953, y = -655.92211914063, z = 33.38126373291, h = 218.53300476074 },
    { name = "23", x = -1458.8846435547, y = -659.21154785156, z = 33.38126373291, h = 216.92980957031 },
    { name = "24", x = -1462.9821777344, y = -662.12194824219, z = 33.38126373291, h = 220.32763671875 },
    { name = "25", x = -1467.5938720703, y = -665.45080566406, z = 33.38126373291, h = 223.64576721191 },
    { name = "26", x = -1471.5115966797, y = -668.3291015625, z = 33.38126373291, h = 221.21588134766 },
    { name = "27", x = -1476.0572509766, y = -671.63409423828, z = 33.381259918213, h = 218.13548278809 },
    { name = "28", x = -1465.1075439453, y = -639.716796875, z = 33.381233215332, h = 36.979179382324 },
    { name = "29", x = -1469.6530761719, y = -642.92132568359, z = 33.381233215332, h = 42.376525878906 },
    { name = "30", x = -1473.6602783203, y = -645.88873291016, z = 33.381233215332, h = 33.006782531738 },
    { name = "31", x = -1478.2044677734, y = -649.17175292969, z = 33.381233215332, h = 36.663181304932 },
    { name = "32", x = -1482.2258300781, y = -652.05767822266, z = 33.381225585938, h = 34.52751159668 },
    { name = "33", x = -1486.7827148438, y = -655.40203857422, z = 33.381225585938, h = 38.338356018066 },
    { name = "34", x = -1490.8363037109, y = -658.32556152344, z = 33.381225585938, h = 34.00666809082 },
    { name = "35", x = -1495.2647705078, y = -661.63946533203, z = 33.381225585938, h = 40.591598510742 },
    { name = "36", x = -1498.1085205078, y = -664.56823730469, z = 33.381225585938, h = 141.62588500977 },
    { name = "37", x = -1493.7041015625, y = -668.32208251953, z = 33.381225585938, h = 141.84553527832 },
    { name = "38", x = -1489.8410644531, y = -671.50451660156, z = 33.381225585938, h = 141.62579345703 },
}

local units = {
    { name = "1", x = 312.92718505859, y =-218.74935913086, z =54.221836090088, h = 157.02673339844 },
    { name = "2", x = 310.97454833984, y =-217.86686706543, z =54.221828460693, h = 163.10821533203 },
    { name = "3", x = 307.41754150391, y =-216.66622924805, z =54.221828460693, h = 154.17195129395 },
    { name = "4", x = 307.67810058594, y =-213.36392211914, z =54.221824645996, h = 78.201683044434 },
    { name = "5", x = 309.51119995117, y =-208.005859375, z =54.221820831299, h = 68.899353027344 },
    { name = "6", x = 311.22863769531, y =-203.42077636719, z =54.221752166748, h = 71.222923278809 },
    { name = "7", x = 313.40740966797, y =-198.14001464844, z =54.221752166748, h = 71.266151428223 },
    { name = "8", x = 315.71633911133, y =-194.89096069336, z =54.226432800293, h = 327.12405395508 },
    { name = "9", x = 319.26400756836, y =-196.32629394531, z =54.226432800293, h = 328.11822509766 },
    { name = "10", x = 321.20629882813, y =-197.30796813965, z =54.226432800293, h = 341.31695556641 },
    { name = "11", x = 313.05545043945, y =-218.40141296387, z =58.019256591797, h = 159.93873596191 },
    { name = "12", x = 311.06958007813, y =-217.59210205078, z =58.019218444824, h = 160.23114013672 },
    { name = "13", x = 307.36392211914, y =-216.35513305664, z =58.019218444824, h = 162.75836181641 },
    { name = "14", x = 307.7624206543, y =-213.42208862305, z =58.019218444824, h = 66.945922851563 },
    { name = "15", x = 309.71682739258, y =-208.10195922852, z =58.019218444824, h = 69.852844238281 },
    { name = "16", x = 311.65313720703, y =-203.61894226074, z =58.019218444824, h = 68.887214660645 },
    { name = "17", x = 313.82775878906, y =-198.35542297363, z =58.019218444824, h = 66.813468933105 },
    { name = "18", x = 315.5671081543, y =-195.2186126709, z =58.019218444824, h = 338.98254394531 },
    { name = "19", x = 319.15594482422, y =-196.57873535156, z =58.0192527771, h = 335.83120727539 },
    { name = "20", x = 321.11340332031, y =-197.55125427246, z =58.0192527771, h = 332.51119995117 },
    { name = "21", x = 329.50228881836, y =-224.64851379395, z =54.221755981445, h = 168.5036315918 },
    { name = "22", x = 331.55038452148, y =-225.62397766113, z =54.221755981445, h = 157.10096740723 },
    { name = "23", x = 335.02069091797, y =-227.23049926758, z =54.221782684326, h = 156.39015197754 },
    { name = "24", x = 336.78451538086, y =-224.6120300293, z =54.221782684326, h = 256.37005615234 },
    { name = "25", x = 338.88705444336, y =-219.30700683594, z =54.221782684326, h = 247.33782958984 },
    { name = "26", x = 340.61981201172, y =-214.6969909668, z =54.221759796143, h = 243.56440734863 },
    { name = "27", x = 342.64764404297, y =-209.41407775879, z =54.221759796143, h = 258.16668701172 },
    { name = "28", x = 344.57653808594, y =-204.91528320313, z =54.221839904785, h = 249.77133178711 },
    { name = "29", x = 346.51461791992, y =-199.5506439209, z =54.221836090088, h = 255.12915039063 },
    { name = "30", x = 329.51705932617, y =-224.70199584961, z =58.019260406494, h = 155.07920837402 },
    { name = "31", x = 331.58178710938, y =-225.60696411133, z =58.019260406494, h = 170.01116943359 },
    { name = "32", x = 335.20101928711, y =-226.93981933594, z =58.019260406494, h = 153.14277648926 },
    { name = "33", x = 336.79022216797, y =-224.59970092773, z =58.019260406494, h = 252.91268920898 },
    { name = "34", x = 338.86596679688, y =-219.3042755127, z =58.019260406494, h = 265.43115234375 },
    { name = "35", x = 340.61856079102, y =-214.53820800781, z =58.019260406494, h = 250.16192626953 },
    { name = "36", x = 342.33416748047, y =-209.48002624512, z =58.019260406494, h = 252.27458190918 },
    { name = "37", x = 344.28021240234, y =-204.78182983398, z =58.019260406494, h = 246.51153564453 },
    { name = "38", x = 346.20147705078, y =-199.39581298828, z =58.019260406494, h = 249.70794677734 },
    { name = "39", x = -1493.4108886719, y = -667.97552490234, z = 29.025072097778, h = 141.66059875488 },
    { name = "40", x = -1498.0126953125, y = -664.73162841797, z = 29.025087356567, h = 139.73707580566 },
    { name = "41", x = -1495.3590087891, y = -661.5869140625, z = 29.025087356567, h = 37.434795379639 },
    { name = "42", x = -1490.6943359375, y = -658.30841064453, z = 29.025085449219, h = 31.892972946167 },
    { name = "43", x = -1486.6990966797, y = -655.400390625, z = 29.583061218262, h = 44.836574554443 },
    { name = "44", x = -1482.2397460938, y = -652.07183837891, z = 29.583070755005, h = 37.552642822266 },
    { name = "45", x = -1478.1522216797, y = -649.14929199219, z = 29.583068847656, h = 41.937004089355 },
    { name = "46", x = -1473.638671875, y = -645.89965820313, z = 29.583070755005, h = 33.83963394165 },
    { name = "47", x = -1469.6915283203, y = -643.04486083984, z = 29.58306312561, h = 34.934692382813 },
    { name = "48", x = -1465.1202392578, y = -639.73565673828, z = 29.583057403564, h = 32.041797637939 },
    { name = "49", x = -1461.3092041016, y = -640.90069580078, z = 29.583116531372, h = 311.34841918945 },
    { name = "50", x = -1452.4534912109, y = -653.18786621094, z = 29.583168029785, h = 303.05084228516 },
    { name = "51", x = -1454.4317626953, y = -655.91137695313, z = 29.583066940308, h = 214.37561035156 },
    { name = "52", x = -1458.9293212891, y = -659.1708984375, z = 29.583070755005, h = 214.57518005371 },
    { name = "53", x = -1462.9853515625, y = -662.11376953125, z = 29.58306312561, h = 221.27893066406 },
    { name = "54", x = -1467.5111083984, y = -665.48724365234, z = 29.583076477051, h = 219.95883178711 },
    { name = "55", x = -1471.5029296875, y = -668.43005371094, z = 29.583135604858, h = 217.13919067383 },
    { name = "56", x = -1461.2722167969, y = -640.96722412109, z = 33.381278991699, h = 311.44879150391 },
    { name = "57", x = -1457.9284667969, y = -645.58898925781, z = 33.38126373291, h = 309.779296875 },
    { name = "58", x = -1455.6176757813, y = -648.60144042969, z = 33.38126373291, h = 307.29852294922 },
    { name = "59", x = -1452.4313964844, y = -653.25042724609, z = 33.38126373291, h = 315.30813598633 },
    { name = "60", x = -1454.3692626953, y = -655.92211914063, z = 33.38126373291, h = 218.53300476074 },
    { name = "61", x = -1458.8846435547, y = -659.21154785156, z = 33.38126373291, h = 216.92980957031 },
    { name = "62", x = -1462.9821777344, y = -662.12194824219, z = 33.38126373291, h = 220.32763671875 },
    { name = "63", x = -1467.5938720703, y = -665.45080566406, z = 33.38126373291, h = 223.64576721191 },
    { name = "64", x = -1471.5115966797, y = -668.3291015625, z = 33.38126373291, h = 221.21588134766 },
    { name = "65", x = -1476.0572509766, y = -671.63409423828, z = 33.381259918213, h = 218.13548278809 },
    { name = "66", x = -1465.1075439453, y = -639.716796875, z = 33.381233215332, h = 36.979179382324 },
    { name = "67", x = -1469.6530761719, y = -642.92132568359, z = 33.381233215332, h = 42.376525878906 },
    { name = "68", x = -1473.6602783203, y = -645.88873291016, z = 33.381233215332, h = 33.006782531738 },
    { name = "69", x = -1478.2044677734, y = -649.17175292969, z = 33.381233215332, h = 36.663181304932 },
    { name = "70", x = -1482.2258300781, y = -652.05767822266, z = 33.381225585938, h = 34.52751159668 },
    { name = "71", x = -1486.7827148438, y = -655.40203857422, z = 33.381225585938, h = 38.338356018066 },
    { name = "72", x = -1490.8363037109, y = -658.32556152344, z = 33.381225585938, h = 34.00666809082 },
    { name = "73", x = -1495.2647705078, y = -661.63946533203, z = 33.381225585938, h = 40.591598510742 },
    { name = "74", x = -1498.1085205078, y = -664.56823730469, z = 33.381225585938, h = 141.62588500977 },
    { name = "75", x = -1493.7041015625, y = -668.32208251953, z = 33.381225585938, h = 141.84553527832 },
    { name = "76", x = -1489.8410644531, y = -671.50451660156, z = 33.381225585938, h = 141.62579345703 },
}

local aptCenter = { name = "Apartment Center", x = 152.89125061035, y = -1003.552734375, z = -99.000007629395, h = 172.08116149902 }
local aptDoor = { name = "Apartment Exit", x = 151.73556518555, y = -1008.3207397461, z = -99.0, h = 23.70355796814 }
local aptStash = { name = "Apartment Stash", x = 150.77499389648, y = -1003.1009521484, z = -98.999992370605, h = 59.155685424805 }
local aptOutfits = { name = "Apartment Outfits", x = 151.07922363281, y = -1001.5975952148, z = -98.999992370605, h = 109.99528503418 }
local aptLogout = { name = "Apartment Logout", x = 154.86790466309, y = -1002.5935668945, z = -98.999992370605, h = 259.78408813477 }

local inApartment = false

RegisterNetEvent('mythic_instances:client:onCreate')
AddEventHandler('mythic_instances:client:onCreate', function(instance)
	if instance.type == 'apartment' then
		TriggerEvent('mythic_instances:client:enter', instance)
	end
end)

RegisterNetEvent('mythic_instances:client:onPlayerLeft')
AddEventHandler('mythic_instances:client:onPlayerLeft', function(instance, player)
	if player == instance.host then
		TriggerEvent('mythic_instances:client:leave')
	end
end)

RegisterNetEvent('mythic_instances:client:onPlayerLeft')
AddEventHandler('mythic_instances:client:onPlayerLeft', function(instance, player)
	if player == instance.host then
		TriggerEvent('mythic_instances:client:leave')
	end
end)

AddEventHandler('mythic_instances:client:loaded', function()
    TriggerEvent('mythic_instances:client:registerType', 'apartment', function(instance)
        print('Entering Instance ...')
	end, function(instance)
        print('Exiting Instance ...')
	end)
end)

RegisterNetEvent('mythic_characters:client:CharacterSpawned')
AddEventHandler('mythic_characters:client:CharacterSpawned', function()
    CheckIfInApt()
end)

RegisterNetEvent('mythic_apartment:client:kickout')
AddEventHandler('mythic_apartment:client:kickout', function()
  if inApartment then
    inApartment = false
    local apt = units[PlayerId() + 1]
    TriggerEvent('mythic_instances:client:leave')
    SendNUIMessage({ action = "exit" })
    SetEntityCoords(GetPlayerPed(-1), apt.x, apt.y, apt.z)
    SetEntityHeading(GetPlayerPed(-1), apt.h)
  end
end)

function CheckIfInApt()
    local apt = units[PlayerId() + 1]
    local plyCoords = GetEntityCoords(GetPlayerPed(-1), 0)
    local cntrDistance = GetDistanceBetweenCoords(aptCenter.x, aptCenter.y, aptCenter.z, plyCoords["x"], plyCoords["y"], plyCoords["z"], true)
    print(cntrDistance < 25 and not inApartment)
    if cntrDistance < 25 and not inApartment then
        inApartment = true
        TriggerEvent('mythic_instances:client:create', 'apartment', {room = apt.name, owner = GetPlayerServerId(PlayerId(-1))})
        startInstanceLoop()
        InApartment()
    end
end

function InApartment()
    local apt = units[PlayerId() + 1]
    Citizen.CreateThread(function()
        Citizen.Wait(1500)
        while inApartment do
            Citizen.Wait(0)
            plyCoords = GetEntityCoords(GetPlayerPed(-1), 0)
            local exitDistance = GetDistanceBetweenCoords(aptDoor.x, aptDoor.y, aptDoor.z, plyCoords["x"], plyCoords["y"], plyCoords["z"], true)
            local stashDistance = GetDistanceBetweenCoords(aptStash.x, aptStash.y, aptStash.z, plyCoords["x"], plyCoords["y"], plyCoords["z"], true)
            local outfitsDistance = GetDistanceBetweenCoords(aptOutfits.x, aptOutfits.y, aptOutfits.z, plyCoords["x"], plyCoords["y"], plyCoords["z"], true)
            local logoutDistance = GetDistanceBetweenCoords(aptLogout.x, aptLogout.y, aptLogout.z, plyCoords["x"], plyCoords["y"], plyCoords["z"], true)

            if stashDistance < 1 then
                DrawText3d(aptStash.x, aptStash.y, aptStash.z,"Stash",0.35)
                if IsControlJustReleased(0, 54) then
                  TriggerServerEvent("vRP:openChest","cheapMotel")
                end
            else
              DrawText3d(aptStash.x, aptStash.y, aptStash.z,"Stash",0.35)
            end

            if outfitsDistance < 1 then
                DrawText3d(aptOutfits.x, aptOutfits.y, aptOutfits.z,"Outfits",0.35)
                if IsControlJustReleased(0, 54) then
                    TriggerServerEvent("vRP:openWardrobe")
                end
            else
                DrawText3d(aptOutfits.x, aptOutfits.y, aptOutfits.z,"Outfits",0.35)
            end

            if logoutDistance < 1 then
                DrawText3d(aptLogout.x, aptLogout.y, aptLogout.z,"Logout",0.35)

                if IsControlJustReleased(0, 54) then
                    TriggerServerEvent("vRP:syncPosition")
                    inApartment = false
                    TriggerEvent('disclaimer:reload')
                    TriggerEvent('mythic_instances:client:leave')
                    TriggerServerEvent('mythic_characters:server:Logout')
                end
            else
                DrawText3d(aptLogout.x, aptLogout.y, aptLogout.z,"Logout",0.35)
            end

            if exitDistance < 1 then
                DrawText3d(aptDoor.x, aptDoor.y, aptDoor.z,"Exit Apartment",0.35)
                if IsControlJustReleased(0, 54) then
                    inApartment = false
                    TriggerEvent('mythic_instances:client:leave')
                    SendNUIMessage({ action = "exit" })
                    SetEntityCoords(GetPlayerPed(-1), apt.x, apt.y, apt.z)
                    SetEntityHeading(GetPlayerPed(-1), apt.h)
                    Citizen.Wait(1500)
                end
            else
                DrawText3d(aptDoor.x, aptDoor.y, aptDoor.z,"Exit Apartment",0.35)
            end
        end
    end)
end

local instanceLoopActive = false

function startInstanceLoop()
  if not instanceLoopActive then
    Citizen.CreateThread(function()
      while inApartment do
        Citizen.Wait(0)
        local playerPed = GetPlayerPed(-1)
        for _, player in ipairs(GetActivePlayers()) do
            local otherPed = GetPlayerPed(player)
            if otherPed ~= playerPed then
              SetEntityVisible(otherPed, false, false)
              SetEntityNoCollisionEntity(playerPed, otherPed, true)
            end
        end
        DisableControls()
      end
      instanceLoopActive = false
    end)
  end
end

Citizen.CreateThread(function()
    local apt = units[PlayerId() + 1]
    while true do
        Citizen.Wait(1)
        --if not exports['mythic_base']:GetIfChoosing() then
            local plyCoords = GetEntityCoords(GetPlayerPed(-1), 0)
            local distance = GetDistanceBetweenCoords(apt.x, apt.y, apt.z, plyCoords["x"], plyCoords["y"], plyCoords["z"], true)
            if distance < 20 then
                DrawMarker(22, apt.x, apt.y, apt.z, 0, 0, 0, 0, 0, 0, 0.5, 0.5, 1.0, 1, 157, 0, 155, true, false, 2, true, false, false, false)

                if not IsPedInAnyVehicle(GetPlayerPed(), true) then
                    if distance < 1 then
                        DrawText3d(apt.x, apt.y, apt.z,"Enter Apartment",0.35)
                        if IsControlJustReleased(0, 54) then
                            inApartment = true
                            TriggerEvent('mythic_instances:client:create', 'apartment', {room = apt.name, owner = GetPlayerServerId(PlayerId(-1))})
                            SendNUIMessage({ action = "enter" })
                            startInstanceLoop()
                            -- Might need to add a delay or trnasition frame here
                            SetEntityCoords(GetPlayerPed(-1), aptDoor.x, aptDoor.y + 1, aptDoor.z)
                            SetEntityHeading(GetPlayerPed(-1), aptDoor.h)
                            InApartment()
                        end
                    end
                end
            else
                Citizen.Wait(5000)
            end
        --end
    end
end)

function DisableControls()
  DisableControlAction(0,21,true) -- disable sprint
  DisableControlAction(0,24,true) -- disable attack
  DisableControlAction(0,25,true) -- disable aim
  DisableControlAction(0,47,true) -- disable weapon
  DisableControlAction(0,58,true) -- disable weapon
  DisableControlAction(0,263,true) -- disable melee
  DisableControlAction(0,264,true) -- disable melee
  DisableControlAction(0,257,true) -- disable melee
  DisableControlAction(0,140,true) -- disable melee
  DisableControlAction(0,141,true) -- disable melee
  DisableControlAction(0,142,true) -- disable melee
  DisableControlAction(0,143,true) -- disable melee
  DisableControlAction(0,75,true) -- disable exit vehicle
  DisableControlAction(27,75,true) -- disable exit vehicle
  DisableControlAction(0,21,true) -- disable sprint
  DisableControlAction(0,36,true) -- disable exit duck
  DisableControlAction(0,47,true) -- disable weapon
  DisableControlAction(0,58,true) -- disable weapon
  DisableControlAction(0,257,true) -- disable melee
  DisableControlAction(0,44,true) -- disable cover
  DisableControlAction(0,22,true) -- disable cover
  DisablePlayerFiring(GetPlayerPed(-1), true) -- Disable weapon firing
  DisableControlAction(0, 106, true) -- VehicleMouseControlOverride
end

function DrawText3d(x,y,z,text,scale,r,g,b)
  local r = r or 255
  local g = g or 255
  local b = b or 255
  local onScreen,_x,_y=World3dToScreen2d(x,y,z)
  local px,py,pz=table.unpack(GetGameplayCamCoords())

  if onScreen then
    SetTextScale(scale, scale)
    SetTextFont(0)
    SetTextProportional(1)
    SetTextColour(r,g,b,255)
    SetTextDropshadow(0, 0, 0, 0, 55)
    SetTextEdge(2, 0, 0, 0, 150)
    SetTextDropShadow()
    SetTextOutline()
    SetTextEntry("STRING")
    SetTextCentre(1)
    AddTextComponentString(text)
    DrawText(_x,_y)
  end
end
